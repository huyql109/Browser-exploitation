FROM ubuntu:20.04

# Setup environment variables
ENV user ctf
ENV prob_port 4444
ENV flag flag

# Install packages
RUN apt-get update 
RUN apt-get install -y socat python3

# Change permission
RUN chmod 1733 /tmp /var/tmp /dev/shm

# Copy binaries and flag
RUN adduser $user
ADD ./runner.py /home/$user/runner.py
ADD ./bin /home/$user/bin
ADD ./$flag /home/$user/$flag
RUN chown -R root:root /home/$user/
RUN chown root:$user /home/$user/runner.py
RUN chown root:$user /home/$user/bin
RUN chown root:$user /home/$user/$flag
RUN chmod 2755 /home/$user/runner.py
RUN chmod 2755 /home/$user/bin/d8
RUN chmod 440 /home/$user/$flag

# final
CMD socat -T 5 TCP-LISTEN:$prob_port,reuseaddr,fork EXEC:/home/$user/runner.py
USER $user
EXPOSE $prob_port